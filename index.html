<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Kalinka: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Kalinka
   </div>
   <div id="projectbrief">Flexible authorization library for PHP</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Kalinka Documentation</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><b>Get downloads and source</b> at the <a href="http://github.com/americancouncils/kalinka">GitHub Project Page</a>.</p>
<p>(This file is also available as <code>README.md</code> in the repository)</p>
<h2>Installation</h2>
<p>You can get Kalinka via composer: </p>
<pre class="fragment">"require": {
    ...
    "ac/kalinka": "dev-master"
}
</pre><h2>Getting Started</h2>
<p>Create a base Guard class for your app. Guards are where you define your security policies. Policies are just boolean-retuning methods whose names start with "policy". Here is an example Guard base class for your app:</p>
<div class="fragment"><div class="line">use AC\Kalinka\Guard\BaseGuard;</div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>MyAppBaseGuard <span class="keyword">extends</span> BaseGuard</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">protected</span> <span class="keyword">function</span> policyAdmin()</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> $this-&gt;subject-&gt;isAdmin();</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p>The <code>subject</code> above is the user whose privileges are being checked. This can be an instance of your app's User class (as the code above assumes), or it can be something as simple as the name of the user as a string. The important thing is that it lets you find out everything you need about the user to determine what they're allowed to do.</p>
<p>Guards may also have an <code>object</code>, which is the resource that the subject is trying to get at. You'll need to write a Guard class for each specific type of resource that has special policies. For example, suppose you have Documents that allow access based on whether or not the user owns that particular document, and/or whether or not the document is "unlocked":</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>DocumentGuard <span class="keyword">extends</span> MyAppBaseGuard</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">protected</span> <span class="keyword">function</span> policyDocumentOwner()</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> ($this-&gt;object-&gt;getOwnerId() == $this-&gt;subject-&gt;getId());</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">protected</span> <span class="keyword">function</span> policyDocumentUnlocked()</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> !($this-&gt;<span class="keywordtype">object</span>-&gt;isLocked());</div>
<div class="line">}</div>
</div><!-- fragment --><p>When your app wants to do some actual access checks, these are done through an Authorizer. The Authorizer determines what Guard policies are applied in any given situation. You can reference the policies implemented in your Guards, as well as the default "allow" policy that simply always permits access.</p>
<p>If you don't define any policy for an action, it is always denies access by default.</p>
<p>For most basic use cases, you can derive from <code>SimpleAuthorizer</code>:</p>
<div class="fragment"><div class="line">use AC\Kalinka\Authorizer\SimpleAuthorizer;</div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>MyAppAuthorizer <span class="keyword">extends</span> SimpleAuthorizer</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">public</span> <span class="keyword">function</span> __construct($subject)</div>
<div class="line">    {</div>
<div class="line">        parent::__construct($subject);</div>
<div class="line"></div>
<div class="line">        $this-&gt;registerGuards([</div>
<div class="line">            <span class="stringliteral">&quot;document&quot;</span> =&gt; <span class="stringliteral">&quot;MyApp\Guards\DocumentGuard&quot;</span>,</div>
<div class="line">            <span class="stringliteral">&quot;comment&quot;</span> =&gt; <span class="stringliteral">&quot;MyApp\Guards\MyAppBaseGuard&quot;</span>,</div>
<div class="line">            <span class="comment">// ... and so on for all your protected resources</span></div>
<div class="line">        ]);</div>
<div class="line"></div>
<div class="line">        $this-&gt;registerActions([</div>
<div class="line">            <span class="stringliteral">&quot;document&quot;</span> =&gt; [<span class="stringliteral">&quot;read&quot;</span>, <span class="stringliteral">&quot;write&quot;</span>],</div>
<div class="line">            <span class="stringliteral">&quot;comment&quot;</span> =&gt; [<span class="stringliteral">&quot;read&quot;</span>, <span class="stringliteral">&quot;create&quot;</span>, <span class="stringliteral">&quot;delete&quot;</span>],</div>
<div class="line">            <span class="comment">// ...</span></div>
<div class="line">        ]);</div>
<div class="line"></div>
<div class="line">        $this-&gt;registerPolicies([</div>
<div class="line">            <span class="stringliteral">&quot;document&quot;</span> =&gt; [</div>
<div class="line">                <span class="stringliteral">&quot;read&quot;</span> =&gt; <span class="stringliteral">&quot;allow&quot;</span>,</div>
<div class="line">                <span class="stringliteral">&quot;write&quot;</span> =&gt; <span class="stringliteral">&quot;documentOwner&quot;</span></div>
<div class="line">            ],</div>
<div class="line">            <span class="stringliteral">&quot;comment&quot;</span> =&gt; [</div>
<div class="line">                <span class="stringliteral">&quot;read&quot;</span> =&gt; <span class="stringliteral">&quot;allow&quot;</span>,</div>
<div class="line">                <span class="stringliteral">&quot;create&quot;</span> =&gt; <span class="stringliteral">&quot;allow&quot;</span>,</div>
<div class="line">                <span class="stringliteral">&quot;delete&quot;</span> =&gt; <span class="stringliteral">&quot;admin&quot;</span></div>
<div class="line">            ],</div>
<div class="line">            <span class="comment">// ...</span></div>
<div class="line">        ]);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p>Notice how comments are handled by <code>MyAppBaseGuard</code>; we did not have to write a new <code>CommentGuard</code> class. We don't have any policies that care about the content of comments, so there's no need to write a special class for guarding them.</p>
<p>Now after all that, we're ready to do authorization! Whenever you want to check if access to some resource is allowed, just create an instance of your Authorizer class and call the <code>can</code> method:</p>
<div class="fragment"><div class="line">use MyApp\MyAppAuthorizer;</div>
<div class="line"></div>
<div class="line">$auth = <span class="keyword">new</span> MyAppAuthorizer($currentUser);</div>
<div class="line"><span class="keywordflow">if</span> ($auth-&gt;can(<span class="stringliteral">&quot;write&quot;</span>, <span class="stringliteral">&quot;document&quot;</span>, $someDocument)) {</div>
<div class="line">    $someDocument-&gt;setContent($newValue);</div>
<div class="line">} <span class="keywordflow">else</span> {</div>
<div class="line">    print <span class="stringliteral">&quot;Access denied!\n&quot;</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><h2>Combining Policies</h2>
<p>Suppose that you only want to allow documents to be edited only if they are unlocked <em>and</em> the user owns them. This can be done by supplying a list of policies instead of a single string:</p>
<div class="fragment"><div class="line"><span class="comment">// ...</span></div>
<div class="line">$this-&gt;registerPolicies([</div>
<div class="line">    <span class="stringliteral">&quot;document&quot;</span> =&gt; [</div>
<div class="line">        <span class="stringliteral">&quot;read&quot;</span> =&gt; <span class="stringliteral">&quot;allow&quot;</span>,</div>
<div class="line">        <span class="stringliteral">&quot;write&quot;</span> =&gt; [</div>
<div class="line">            <span class="stringliteral">&quot;documentUnlocked&quot;</span>,</div>
<div class="line">            <span class="stringliteral">&quot;documentOwner&quot;</span></div>
<div class="line">        ]</div>
<div class="line">    ],</div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">]);</div>
</div><!-- fragment --><p>Sometimes an action is permitted if any one of several different policies allows it, even if the others do not. Suppose that for the purposes of writing documents, being an admin is as good as being the document's owner, but the rule about the document being unlocked still applies to everyone. In that case, you can use an inner list:</p>
<div class="fragment"><div class="line"><span class="comment">// ...</span></div>
<div class="line">$this-&gt;registerPolicies([</div>
<div class="line">    <span class="stringliteral">&quot;document&quot;</span> =&gt; [</div>
<div class="line">        <span class="stringliteral">&quot;read&quot;</span> =&gt; <span class="stringliteral">&quot;allow&quot;</span>,</div>
<div class="line">        <span class="stringliteral">&quot;write&quot;</span> =&gt; [</div>
<div class="line">            <span class="stringliteral">&quot;documentUnlocked&quot;</span>,</div>
<div class="line">            [<span class="stringliteral">&quot;documentOwner&quot;</span>, <span class="stringliteral">&quot;admin&quot;</span>]</div>
<div class="line">        ]</div>
<div class="line">    ],</div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">]);</div>
</div><!-- fragment --><p>The principle here is that the outer list is AND-connected, while inner lists are OR-connected.</p>
<p>If you need something even more complicated than that, you could always implement it as its own policy. Policies can call each other with the <code>checkPolicy()</code> method on <code>BaseGuard</code>.</p>
<h2>Roles</h2>
<p><code>SimpleAuthorizer</code> will only work for very straightforward setups, where the same policies apply to everyone. In real systems, it's more common that you have a bunch of different roles that people can belong to, each of which has access to resources under a variety of different circumstances. The easiest way to accomplish this is to extend from <code>RoleAuthorizer</code>, which provides a <code>registerRolePolicies()</code> method:</p>
<div class="fragment"><div class="line">use AC\Kalinka\Authorizer\RoleAuthorizer;</div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>MyAppAuthorizer <span class="keyword">extends</span> RoleAuthorizer</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">public</span> <span class="keyword">function</span> __construct(MyUserClass $user)</div>
<div class="line">    {</div>
<div class="line">        $roleNames = [];</div>
<div class="line">        <span class="keywordflow">foreach</span> ($user-&gt;getRoles() as $role) {</div>
<div class="line">            $roleNames[] = $role-&gt;getName();</div>
<div class="line">        }</div>
<div class="line">        parent::__construct($roleNames, $user);</div>
<div class="line"></div>
<div class="line">        $this-&gt;registerGuards([</div>
<div class="line">            <span class="stringliteral">&quot;document&quot;</span> =&gt; <span class="stringliteral">&quot;MyApp\Guards\DocumentGuard&quot;</span>,</div>
<div class="line">            <span class="stringliteral">&quot;comment&quot;</span> =&gt; <span class="stringliteral">&quot;MyApp\Guards\MyAppBaseGuard&quot;</span>,</div>
<div class="line">            <span class="comment">// ... and so on for all your protected resources</span></div>
<div class="line">        ]);</div>
<div class="line"></div>
<div class="line">        $this-&gt;registerActions([</div>
<div class="line">            <span class="stringliteral">&quot;document&quot;</span> =&gt; [<span class="stringliteral">&quot;read&quot;</span>, <span class="stringliteral">&quot;write&quot;</span>],</div>
<div class="line">            <span class="stringliteral">&quot;comment&quot;</span> =&gt; [<span class="stringliteral">&quot;read&quot;</span>, <span class="stringliteral">&quot;create&quot;</span>, <span class="stringliteral">&quot;delete&quot;</span>],</div>
<div class="line">            <span class="comment">// ...</span></div>
<div class="line">        ]);</div>
<div class="line"></div>
<div class="line">        $this-&gt;registerRolePolicies([</div>
<div class="line">            <span class="stringliteral">&quot;guest&quot;</span> =&gt; [</div>
<div class="line">                <span class="stringliteral">&quot;document&quot;</span> =&gt; [</div>
<div class="line">                    <span class="stringliteral">&quot;read&quot;</span> =&gt; <span class="stringliteral">&quot;allow&quot;</span>,</div>
<div class="line">                ],</div>
<div class="line">                <span class="stringliteral">&quot;comment&quot;</span> =&gt; [</div>
<div class="line">                    <span class="stringliteral">&quot;read&quot;</span> =&gt; <span class="stringliteral">&quot;allow&quot;</span>,</div>
<div class="line">                ]</div>
<div class="line">            ],</div>
<div class="line">            <span class="stringliteral">&quot;customer&quot;</span> =&gt; [</div>
<div class="line">                <span class="stringliteral">&quot;document&quot;</span> =&gt; [</div>
<div class="line">                    <span class="stringliteral">&quot;read&quot;</span> =&gt; <span class="stringliteral">&quot;allow&quot;</span>,</div>
<div class="line">                    <span class="stringliteral">&quot;write&quot;</span> =&gt; [</div>
<div class="line">                        <span class="stringliteral">&quot;documentUnlocked&quot;</span>,</div>
<div class="line">                        <span class="stringliteral">&quot;documentOwner&quot;</span></div>
<div class="line">                    ]</div>
<div class="line">                ],</div>
<div class="line">                <span class="stringliteral">&quot;comment&quot;</span> =&gt; [</div>
<div class="line">                    <span class="stringliteral">&quot;read&quot;</span> =&gt; <span class="stringliteral">&quot;allow&quot;</span>,</div>
<div class="line">                    <span class="stringliteral">&quot;create&quot;</span> =&gt; <span class="stringliteral">&quot;allow&quot;</span>,</div>
<div class="line">                ],</div>
<div class="line">                <span class="comment">// ...</span></div>
<div class="line">            ],</div>
<div class="line">            <span class="stringliteral">&quot;admin&quot;</span> =&gt; [</div>
<div class="line">                <span class="stringliteral">&quot;document&quot;</span> =&gt; [</div>
<div class="line">                    <span class="stringliteral">&quot;read&quot;</span> =&gt; <span class="stringliteral">&quot;allow&quot;</span>,</div>
<div class="line">                    <span class="stringliteral">&quot;write&quot;</span> =&gt; <span class="stringliteral">&quot;documentUnlocked&quot;</span></div>
<div class="line">                ],</div>
<div class="line">                <span class="stringliteral">&quot;comment&quot;</span> =&gt; [</div>
<div class="line">                    <span class="stringliteral">&quot;read&quot;</span> =&gt; <span class="stringliteral">&quot;allow&quot;</span>,</div>
<div class="line">                    <span class="stringliteral">&quot;create&quot;</span> =&gt; <span class="stringliteral">&quot;allow&quot;</span>,</div>
<div class="line">                    <span class="stringliteral">&quot;delete&quot;</span> =&gt; <span class="stringliteral">&quot;allow&quot;</span></div>
<div class="line">                ]</div>
<div class="line">            ]</div>
<div class="line">        ]);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p>The roles are supplied as a list of strings. When a permissions check is made, each role is tried individually; if any role assigned to the user allows the action, then it is allowed overall.</p>
<p>This is a much more flexible solution than adding role-like policies to your Guards, as we did above with the <code>policyAdmin()</code> method of <code>MyAppBaseGuard</code>. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Feb 20 2013 13:54:10 for Kalinka by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.1.2
</small></address>
</body>
</html>
